var nfField=Backbone.Model.extend({toggleMetabox:function(){var b=this.id;var c=this.get("metabox_state");if(c==1){var a=0}else{var a=1}if(a==1){this.updateHTML()}else{this.updateData();jQuery("#ninja_forms_field_"+b+"_inside").find("div.rte").each(function(){if("undefined"!=typeof tinymce){try{var f=jQuery(this).find("textarea.wp-editor-area").prop("id");tinymce.remove("#"+f)}catch(d){}}});jQuery("#ninja_forms_field_"+b+"_inside").slideUp("fast",function(d){jQuery("#ninja_forms_field_"+b+"_inside").empty();jQuery("#ninja_forms_field_"+b+"_inside").addClass("no-padding")})}this.set("metabox_state",a)},updateHTML:function(){var a=this.id;jQuery("#ninja_forms_metabox_field_"+a).find(".spinner").show();jQuery("#ninja_forms_metabox_field_"+a).find(".spinner").css("visibility","visible");this.updateData();var c=JSON.stringify(this.toJSON());var b=this;jQuery.post(ajaxurl,{field_id:a,data:c,action:"nf_output_field_settings_html",nf_ajax_nonce:ninja_forms_settings.nf_ajax_nonce},function(f){jQuery("#ninja_forms_metabox_field_"+a).find(".spinner").hide();jQuery("#ninja_forms_field_"+a+"_inside").removeClass("no-padding");jQuery("#ninja_forms_field_"+a+"_inside").append(f);if(typeof nf_ajax_rte_editors!=="undefined"&&"undefined"!==typeof tinyMCE){for(var d=nf_ajax_rte_editors.length-1;d>=0;d--){try{var h=nf_ajax_rte_editors[d];tinyMCE.init(tinyMCEPreInit.mceInit[h]);try{quicktags(tinyMCEPreInit.qtInit[h])}catch(g){console.log("error")}}catch(g){}}}b.removeEmptySettings();jQuery("#ninja_forms_field_"+a+"_inside").slideDown("fast");nfFields.listOptionsSortable();jQuery(".nf-field-settings .title").disableSelection()})},updateData:function(){var a=this.id;if("undefined"!=typeof tinyMCE){try{tinyMCE.triggerSave()}catch(d){}}var b=jQuery("[name^=ninja_forms_field_"+a+"]");var g=jQuery(b).serializeFullArray();if(typeof g["ninja_forms_field_"+a]!="undefined"){var c=g["ninja_forms_field_"+a];for(var f in c){if(c.hasOwnProperty(f)){nfFields.get(a).set(f,c[f])}}}nfForm.set("saved",false)},remove:function(){var b=this.id;var c=confirm(nf_admin.remove_field);if(c){var a=ninja_forms_settings.form_id;jQuery.post(ajaxurl,{form_id:a,field_id:b,action:"ninja_forms_remove_field",nf_ajax_nonce:ninja_forms_settings.nf_ajax_nonce},function(d){jQuery("#ninja_forms_field_"+b).remove();jQuery(document).trigger("removeField",[b])})}},removeEmptySettings:function(){var a=this.id;jQuery("#ninja_forms_field_"+a+"_inside").find(".nf-field-settings .inside").each(function(){var b=jQuery.trim(jQuery(this).html());if(b==""){jQuery(this).parent().remove()}})}});var nfFields=Backbone.Collection.extend({model:nfField,setup:function(){if("undefined"!==typeof nf_admin.fields){_.each(nf_admin.fields,function(a){nfFields.add({id:a.id,metabox_state:a.metabox_state})})}},updateData:function(){_.each(this.models,function(a){if(a.get("metabox_state")==1){a.updateData()}})},newField:function(d){var b=jQuery(d).data("limit");var f=jQuery(d).data("type");var a=ninja_forms_settings.form_id;if(b!=""){var c=jQuery("."+f+"-li").length}else{var c=""}if(typeof jQuery(d).data("field")=="undefined"){var e="";var g="ninja_forms_new_field"}else{if(jQuery(d).data("type")=="fav"){var e=jQuery(d).data("field");var g="ninja_forms_insert_fav"}else{var e=jQuery(d).data("field");var g="ninja_forms_insert_def"}}if((b!=""&&c<b)||b==""||c==""||c==0){jQuery.post(ajaxurl,{type:f,field_id:e,form_id:a,action:g,nf_ajax_nonce:ninja_forms_settings.nf_ajax_nonce},this.newFieldResponse)}else{jQuery(d).addClass("disabled")}nfForm.set("saved",false)},newFieldResponse:function(a){jQuery(document).trigger("addField",[a])},addFieldDefault:function(b){jQuery("#ninja_forms_field_list").append(b.new_html).show("slow");if(b.new_type=="List"){this.listOptionsSortable()}if(typeof nf_ajax_rte_editors!=="undefined"&&"undefined"!==typeof tinyMCE){for(var a=nf_ajax_rte_editors.length-1;a>=0;a--){try{var d=nf_ajax_rte_editors[a];tinyMCE.init(tinyMCEPreInit.mceInit[d]);try{quicktags(tinyMCEPreInit.qtInit[d])}catch(c){}}catch(c){}}}this.add({id:b.new_id,metabox_state:1});nfFields.get(b.new_id).removeEmptySettings()},listOptionsSortable:function(a){jQuery(".ninja-forms-field-list-options").sortable({helper:"clone",handle:".ninja-forms-drag",items:"div",placeholder:"ui-state-highlight",update:function(d,e){var c=jQuery(this).sortable("toArray");var b=0;_.each(c,function(k){var i=jQuery("#"+k).data("field");var g="ninja_forms_field_"+i+"[list][options]["+b+"][label]";var f="ninja_forms_field_"+i+"[list][options]["+b+"][value]";var j="ninja_forms_field_"+i+"[list][options]["+b+"][calc]";var h="ninja_forms_field_"+i+"[list][options]["+b+"][selected]";jQuery("#"+k).find(".ninja-forms-field-list-option-label").attr("name",g);jQuery("#"+k).find(".ninja-forms-field-list-option-value").attr("name",f);jQuery("#"+k).find(".ninja-forms-field-list-option-calc").attr("name",j);jQuery("#"+k).find(".ninja-forms-field-list-option-selected").attr("name",h);b++})}})}});var nfForm=Backbone.Model.extend({defaults:{id:ninja_forms_settings.form_id,status:nf_admin.form_status,title:nf_admin.form_title,saved:true},setup:function(){this.changeMenu()},changeMenu:function(){if("new"==this.get("status")){jQuery(".wp-submenu li").removeClass("current");jQuery('a[href="admin.php?page=ninja-forms&tab=builder&form_id=new"]').parent().addClass("current")}else{var a='<li class="current"><a href="#">'+nf_admin.edit_form_text+"</a></li>";if(jQuery('li a:contains("'+nf_admin.edit_form_text+'")').length==0){jQuery(".wp-submenu li").removeClass("current");jQuery('a[href="admin.php?page=ninja-forms&tab=builder&form_id=new"]').parent().after(a)}}},save:function(){jQuery(".nf-save-admin-fields").hide();jQuery(".nf-save-spinner").show();jQuery(".nf-save-spinner").css("visibility","visible");if("new"==this.get("status")){if(jQuery("._submit-li").length>0){jQuery("#nf-insert-submit-div").hide();this.set("show_insert_submit",false)}else{jQuery("#nf-insert-submit-div").show();this.set("show_insert_submit",true)}jQuery("#nf-save-title").nfAdminModal("open");jQuery("#modal-contents-wrapper").find("#nf-form-title").focus();return false}nfFields.updateData();var f=JSON.stringify(nfFields.toJSON());var e={};var d=jQuery("#ninja_forms_field_list").sortable("toArray");for(var b=0;b<d.length;b++){e[b]=d[b]}e=JSON.stringify(e);var a=ninja_forms_settings.form_id;jQuery(document).data("field_order",e);jQuery(document).data("field_data",f);jQuery(document).triggerHandler("nfAdminSaveFields");var e=jQuery(document).data("field_order");var c=jQuery(document).data("field_data");jQuery.post(ajaxurl,{form_title:this.get("title"),form_id:a,field_data:f,field_order:e,action:"nf_admin_save_builder",nf_ajax_nonce:ninja_forms_settings.nf_ajax_nonce},function(g){jQuery(".nf-save-spinner").hide();jQuery(".nf-save-admin-fields").show();var h='<div id="message" class="updated below-h2" style="display:none;margin-top: 20px;"><p>'+nf_admin.saved_text+"</p></div>";jQuery(".nav-tab-wrapper:last").after(h);jQuery("#message").fadeIn();if(jQuery("#nf-display-form-title").html()==""){jQuery("#nf-display-form-title").html(nfForm.get("title"))}nfForm.set("saved",true);nfForm.set("status","");nfForm.changeMenu()})},saveTitle:function(){var d=jQuery("#modal-contents-wrapper").find("#nf-form-title").val();var b=this.get("show_insert_submit");var c=jQuery("#modal-contents-wrapper").find("#nf-insert-submit").prop("checked");this.set("title",d);this.set("status","");if(b&&c){var a=this;jQuery(document).on("addField.insertSubmit",function(g,f){jQuery("#ninja_forms_field_"+f.new_id+"_toggle").click();jQuery("#nf-save-title").nfAdminModal("close");a.save();jQuery(document).off("addField.insertSubmit")});jQuery("#_submit").click()}else{jQuery("#nf-save-title").nfAdminModal("close");this.save()}}});var nfFields=new nfFields();var nfForm=new nfForm();(function(a){a(document).ready(function(b){nfFields.setup();nfForm.setup();b(document).on("click",".nf-edit-field",function(f){f.preventDefault();var c=jQuery(f.target).data("field");nfFields.get(c).toggleMetabox();var d=nfFields.get(c).get("metabox_state");if(d==1){b(this).addClass("open")}else{b(this).removeClass("open")}});b(document).on("click",function(){b("#message").fadeOut("slow")});b(document).on("click",".nf-save-admin-fields",function(c){c.preventDefault();nfForm.save()});b(document).on("click","#nf-save-title-submit",function(c){c.preventDefault();nfForm.saveTitle()});b(document).on("click",".ninja-forms-new-field",function(c){c.preventDefault();nfFields.newField(c.target)});b(document).on("click",".nf-remove-field",function(d){d.preventDefault();var c=jQuery(d.target).data("field");nfFields.get(c).remove()});b(document).on("addField.default",function(d,c){nfFields.addFieldDefault(c)});b(document).on("click",".ninja-forms-insert-fav-field",function(c){c.preventDefault();nfFields.newField(c.target)});b(document).on("click",".ninja-forms-insert-def-field",function(c){c.preventDefault();nfFields.newField(c.target)});b("#nf-save-title").nfAdminModal({title:"Save Your Form",buttons:"#nf-save-title-buttons"});b(document).on("nfAdminModalClose.hideSpinners",function(c){jQuery(".nf-save-spinner").hide();jQuery(".nf-save-admin-fields").show()});b(document).on("keyup","#nf-form-title",function(d){var c=this.value;if(this.value.length>0){b("#modal-contents-wrapper").find("#nf-save-title-submit").prop("disabled",false);b("#modal-contents-wrapper").find("#nf-save-title-submit").removeClass("button-secondary");b("#modal-contents-wrapper").find("#nf-save-title-submit").addClass("button-primary")}else{b("#modal-contents-wrapper").find("#nf-save-title-submit").prop("disabled",true);b("#modal-contents-wrapper").find("#nf-save-title-submit").removeClass("button-primary");b("#modal-contents-wrapper").find("#nf-save-title-submit").addClass("button-secondary")}if(d.keyCode==13&&this.value.length>0){nfForm.saveTitle()}});b(".ninja-forms-field-list").sortable({handle:".menu-item-handle",items:"li:not(.not-sortable)",connectWith:".ninja-forms-field-list",start:function(f,d){var c=b(d.item).find(".wp-editor-wrap").length;if(c>0){b(d.item).find(".wp-editor-wrap").each(function(){try{var g=this.id.replace("wp- ","");g=g.replace("-wrap","");tinyMCE.execCommand("mceRemoveControl",false,g)}catch(h){}})}},stop:function(f,d){var c=b(d.item).find(".wp-editor-wrap").length;if(c>0){b(d.item).find(".wp-editor-wrap").each(function(){try{var g=this.id.replace("wp-","");g=g.replace("-wrap","");tinyMCE.execCommand("mceAddControl",true,g)}catch(h){}})}b(this).sortable("refresh");nfForm.set("saved",false)}});b(document).on("dblclick",".nf-field-settings .title",function(c){b(this).find(".nf-field-sub-section-toggle").click()});b(document).on("click",".nf-field-sub-section-toggle",function(c){c.preventDefault();if(b(this).hasClass("dashicons-arrow-right")){b(this).removeClass("dashicons-arrow-right").addClass("dashicons-arrow-up")}else{b(this).removeClass("dashicons-arrow-up").addClass("dashicons-arrow-right")}b(this).parent().next(".inside").slideToggle()});b(window).bind("beforeunload",function(){if("new"==nfForm.get("status")){b("#nf-save-title").nfAdminModal("open");return"Please save your form before leaving this page."}else{if(nfForm.get("saved")==false){return"You have unsaved changes. Please save before leaving this page."}}});b(document).on("dblclick",".menu-item-handle",function(c){b(this).find(".nf-edit-field").click()})})})(jQuery);