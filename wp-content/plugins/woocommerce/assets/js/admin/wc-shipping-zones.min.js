(function(c,b,a,d){c(function(){var m=c(".wc-shipping-zones"),g=c(".wc-shipping-zone-rows"),i=c(".wc-shipping-zone-save"),j=a.template("wc-shipping-zone-row"),e=a.template("wc-shipping-zone-row-blank"),f=Backbone.Model.extend({changes:{},logChanges:function(n){var o=this.changes||{};_.each(n,function(p,q){o[q]=_.extend(o[q]||{zone_id:q},p)});this.changes=o;this.trigger("change:zones")},discardChanges:function(q){var p=this.changes||{},o=null,n=_.indexBy(this.get("zones"),"zone_id");if(p[q]&&p[q].zone_order!==undefined){o=p[q].zone_order}delete p[q];if(o!==null&&n[q]&&n[q].zone_order!==o){p[q]=_.extend(p[q]||{},{zone_id:q,zone_order:o})}this.changes=p;if(0===_.size(this.changes)){l.clearUnloadConfirmation()}},save:function(){if(_.size(this.changes)){c.post(d+(d.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zones_save_changes",{wc_shipping_zones_nonce:b.wc_shipping_zones_nonce,changes:this.changes},this.onSaveResponse,"json")}else{k.trigger("saved:zones")}},onSaveResponse:function(n,o){if("success"===o){if(n.success){k.set("zones",n.data.zones);k.trigger("change:zones");k.changes={};k.trigger("saved:zones")}else{window.alert(b.strings.save_failed)}}}}),h=Backbone.View.extend({rowTemplate:j,initialize:function(){this.listenTo(this.model,"change:zones",this.setUnloadConfirmation);this.listenTo(this.model,"saved:zones",this.clearUnloadConfirmation);this.listenTo(this.model,"saved:zones",this.render);g.on("change",{view:this},this.updateModelOnChange);g.on("sortupdate",{view:this},this.updateModelOnSort);c(window).on("beforeunload",{view:this},this.unloadConfirmation);c(document.body).on("click",".wc-shipping-zone-add",{view:this},this.onAddNewRow)},block:function(){c(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:0.6}})},unblock:function(){c(this.el).unblock()},render:function(){var o=_.indexBy(this.model.get("zones"),"zone_id"),n=this;n.$el.empty();n.unblock();if(_.size(o)){o=_(o).chain().sortBy(function(p){return parseInt(p.zone_id,10)}).sortBy(function(p){return parseInt(p.zone_order,10)}).value();c.each(o,function(q,p){n.renderRow(p)})}else{n.$el.append(e)}n.initRows()},renderRow:function(o){var n=this;n.$el.append(n.rowTemplate(o));n.initRow(o)},initRow:function(p){var n=this;var o=n.$el.find('tr[data-id="'+p.zone_id+'"]');n.renderShippingMethods(p.zone_id,p.shipping_methods);o.find(".wc-shipping-zone-delete").on("click",{view:this},this.onDeleteRow)},initRows:function(){if(0===(c("tbody.wc-shipping-zone-rows tr").length%2)){m.find("tbody.wc-shipping-zone-rows").next("tbody").find("tr").addClass("odd")}else{m.find("tbody.wc-shipping-zone-rows").next("tbody").find("tr").removeClass("odd")}c("#tiptip_holder").removeAttr("style");c("#tiptip_arrow").removeAttr("style");c(".tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:50})},renderShippingMethods:function(p,n){var q=c('.wc-shipping-zones tr[data-id="'+p+'"]');var o=q.find(".wc-shipping-zone-methods ul");o.find(".wc-shipping-zone-method").remove();if(_.size(n)){n=_.sortBy(n,function(r){return parseInt(r.method_order,10)});_.each(n,function(s){var r="method_disabled";if("yes"===s.enabled){r="method_enabled"}o.append('<li class="wc-shipping-zone-method '+r+'">'+s.title+"</li>")})}else{o.append('<li class="wc-shipping-zone-method">'+b.strings.no_shipping_methods_offered+"</li>")}},onDeleteRow:function(s){var o=s.data.view,q=o.model,n=_.indexBy(q.get("zones"),"zone_id"),r={},t=c(this).closest("tr"),p=t.data("id");s.preventDefault();if(window.confirm(b.strings.delete_confirmation_msg)){if(n[p]){delete n[p];r[p]=_.extend(r[p]||{},{deleted:"deleted"});q.set("zones",n);q.logChanges(r);s.data.view.block();s.data.view.model.save()}}},setUnloadConfirmation:function(){this.needsUnloadConfirm=true;i.prop("disabled",false)},clearUnloadConfirmation:function(){this.needsUnloadConfirm=false;i.prop("disabled",true)},unloadConfirmation:function(n){if(n.data.view.needsUnloadConfirm){n.returnValue=b.strings.unload_confirmation_msg;window.event.returnValue=b.strings.unload_confirmation_msg;return b.strings.unload_confirmation_msg}},updateModelOnChange:function(t){var q=t.data.view.model,n=c(t.target),p=n.closest("tr").data("id"),s=n.data("attribute"),u=n.val(),o=_.indexBy(q.get("zones"),"zone_id"),r={};if(!o[p]||o[p][s]!==u){r[p]={};r[p][s]=u}q.logChanges(r)},updateModelOnSort:function(r){var o=r.data.view,p=o.model,n=_.indexBy(p.get("zones"),"zone_id"),s=c("tbody.wc-shipping-zone-rows tr"),q={};_.each(s,function(w){var t=c(w).data("id"),v=null,u=parseInt(c(w).index(),10);if(n[t]){v=parseInt(n[t].zone_order,10)}if(v!==u){q[t]=_.extend(q[t]||{},{zone_order:u})}});if(_.size(q)){p.logChanges(q);r.data.view.block();r.data.view.model.save()}}}),k=new f({zones:b.zones}),l=new h({model:k,el:g});l.render();g.sortable({items:"tr",cursor:"move",axis:"y",handle:"td.wc-shipping-zone-sort",scrollSensitivity:40})})})(jQuery,shippingZonesLocalizeScript,wp,ajaxurl);