(function(h,e,f,g){h(function(){var a=h(".wc-shipping-zones"),p=h(".wc-shipping-zone-rows"),n=h(".wc-shipping-zone-save"),d=f.template("wc-shipping-zone-row"),r=f.template("wc-shipping-zone-row-blank"),q=Backbone.Model.extend({changes:{},logChanges:function(j){var i=this.changes||{};_.each(j,function(l,k){i[k]=_.extend(i[k]||{zone_id:k},l)});this.changes=i;this.trigger("change:zones")},discardChanges:function(i){var j=this.changes||{},k=null,l=_.indexBy(this.get("zones"),"zone_id");if(j[i]&&j[i].zone_order!==undefined){k=j[i].zone_order}delete j[i];if(k!==null&&l[i]&&l[i].zone_order!==k){j[i]=_.extend(j[i]||{},{zone_id:i,zone_order:k})}this.changes=j;if(0===_.size(this.changes)){b.clearUnloadConfirmation()}},save:function(){if(_.size(this.changes)){h.post(g+(g.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zones_save_changes",{wc_shipping_zones_nonce:e.wc_shipping_zones_nonce,changes:this.changes},this.onSaveResponse,"json")}else{c.trigger("saved:zones")}},onSaveResponse:function(j,i){if("success"===i){if(j.success){c.set("zones",j.data.zones);c.trigger("change:zones");c.changes={};c.trigger("saved:zones")}else{window.alert(e.strings.save_failed)}}}}),o=Backbone.View.extend({rowTemplate:d,initialize:function(){this.listenTo(this.model,"change:zones",this.setUnloadConfirmation);this.listenTo(this.model,"saved:zones",this.clearUnloadConfirmation);this.listenTo(this.model,"saved:zones",this.render);p.on("change",{view:this},this.updateModelOnChange);p.on("sortupdate",{view:this},this.updateModelOnSort);h(window).on("beforeunload",{view:this},this.unloadConfirmation);h(document.body).on("click",".wc-shipping-zone-add",{view:this},this.onAddNewRow)},block:function(){h(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:0.6}})},unblock:function(){h(this.el).unblock()},render:function(){var i=_.indexBy(this.model.get("zones"),"zone_id"),j=this;j.$el.empty();j.unblock();if(_.size(i)){i=_(i).chain().sortBy(function(k){return parseInt(k.zone_id,10)}).sortBy(function(k){return parseInt(k.zone_order,10)}).value();h.each(i,function(k,l){j.renderRow(l)})}else{j.$el.append(r)}j.initRows()},renderRow:function(i){var j=this;j.$el.append(j.rowTemplate(i));j.initRow(i)},initRow:function(i){var k=this;var j=k.$el.find('tr[data-id="'+i.zone_id+'"]');k.renderShippingMethods(i.zone_id,i.shipping_methods);j.find(".wc-shipping-zone-delete").on("click",{view:this},this.onDeleteRow)},initRows:function(){if(0===(h("tbody.wc-shipping-zone-rows tr").length%2)){a.find("tbody.wc-shipping-zone-rows").next("tbody").find("tr").addClass("odd")}else{a.find("tbody.wc-shipping-zone-rows").next("tbody").find("tr").removeClass("odd")}h("#tiptip_holder").removeAttr("style");h("#tiptip_arrow").removeAttr("style");h(".tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:50})},renderShippingMethods:function(j,l){var i=h('.wc-shipping-zones tr[data-id="'+j+'"]');var k=i.find(".wc-shipping-zone-methods ul");k.find(".wc-shipping-zone-method").remove();if(_.size(l)){l=_.sortBy(l,function(m){return parseInt(m.method_order,10)});_.each(l,function(m){var t="method_disabled";if("yes"===m.enabled){t="method_enabled"}k.append('<li class="wc-shipping-zone-method '+t+'">'+m.title+"</li>")})}else{k.append('<li class="wc-shipping-zone-method">'+e.strings.no_shipping_methods_offered+"</li>")}},onDeleteRow:function(j){var u=j.data.view,l=u.model,v=_.indexBy(l.get("zones"),"zone_id"),k={},i=h(this).closest("tr"),m=i.data("id");j.preventDefault();if(window.confirm(e.strings.delete_confirmation_msg)){if(v[m]){delete v[m];k[m]=_.extend(k[m]||{},{deleted:"deleted"});l.set("zones",v);l.logChanges(k);j.data.view.block();j.data.view.model.save()}}},setUnloadConfirmation:function(){this.needsUnloadConfirm=true;n.prop("disabled",false)},clearUnloadConfirmation:function(){this.needsUnloadConfirm=false;n.prop("disabled",true)},unloadConfirmation:function(i){if(i.data.view.needsUnloadConfirm){i.returnValue=e.strings.unload_confirmation_msg;window.event.returnValue=e.strings.unload_confirmation_msg;return e.strings.unload_confirmation_msg}},updateModelOnChange:function(j){var m=j.data.view.model,x=h(j.target),v=x.closest("tr").data("id"),k=x.data("attribute"),i=x.val(),w=_.indexBy(m.get("zones"),"zone_id"),l={};if(!w[v]||w[v][k]!==i){l[v]={};l[v][k]=i}m.logChanges(l)},updateModelOnSort:function(j){var m=j.data.view,l=m.model,t=_.indexBy(l.get("zones"),"zone_id"),i=h("tbody.wc-shipping-zone-rows tr"),k={};_.each(i,function(s){var z=h(s).data("id"),x=null,y=parseInt(h(s).index(),10);if(t[z]){x=parseInt(t[z].zone_order,10)}if(x!==y){k[z]=_.extend(k[z]||{},{zone_order:y})}});if(_.size(k)){l.logChanges(k);j.data.view.block();j.data.view.model.save()}}}),c=new q({zones:e.zones}),b=new o({model:c,el:p});b.render();p.sortable({items:"tr",cursor:"move",axis:"y",handle:"td.wc-shipping-zone-sort",scrollSensitivity:40})})})(jQuery,shippingZonesLocalizeScript,wp,ajaxurl);