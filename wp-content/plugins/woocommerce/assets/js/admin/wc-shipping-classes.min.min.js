(function(h,e,f,g){h(function(){var p=h(".wc-shipping-class-rows"),d=h(".wc-shipping-class-save"),c=f.template("wc-shipping-class-row"),n=f.template("wc-shipping-class-row-blank"),m=Backbone.Model.extend({changes:{},logChanges:function(i){var j=this.changes||{};_.each(i,function(l,k){j[k]=_.extend(j[k]||{term_id:k},l)});this.changes=j;this.trigger("change:classes")},save:function(){if(_.size(this.changes)){h.post(g+(g.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_classes_save_changes",{wc_shipping_classes_nonce:e.wc_shipping_classes_nonce,changes:this.changes},this.onSaveResponse,"json")}else{o.trigger("saved:classes")}},discardChanges:function(j){var i=this.changes||{};delete i[j];if(0===_.size(this.changes)){b.clearUnloadConfirmation()}},onSaveResponse:function(i,j){if("success"===j){if(i.success){o.set("classes",i.data.shipping_classes);o.trigger("change:classes");o.changes={};o.trigger("saved:classes")}else{if(i.data){window.alert(i.data)}else{window.alert(e.strings.save_failed)}}}b.unblock()}}),a=Backbone.View.extend({rowTemplate:c,initialize:function(){this.listenTo(this.model,"change:classes",this.setUnloadConfirmation);this.listenTo(this.model,"saved:classes",this.clearUnloadConfirmation);this.listenTo(this.model,"saved:classes",this.render);p.on("change",{view:this},this.updateModelOnChange);h(window).on("beforeunload",{view:this},this.unloadConfirmation);d.on("click",{view:this},this.onSubmit);h(document.body).on("click",".wc-shipping-class-add",{view:this},this.onAddNewRow);h(document.body).on("click",".wc-shipping-class-save-changes",{view:this},this.onSubmit)},block:function(){h(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:0.6}})},unblock:function(){h(this.el).unblock()},render:function(){var j=_.indexBy(this.model.get("classes"),"term_id"),i=this;this.$el.empty();this.unblock();if(_.size(j)){j=_.sortBy(j,function(k){return k.name});h.each(j,function(k,l){i.renderRow(l)})}else{i.$el.append(n)}},renderRow:function(j){var i=this;i.$el.append(i.rowTemplate(j));i.initRow(j)},initRow:function(j){var i=this;var k=i.$el.find('tr[data-id="'+j.term_id+'"]');k.find("select").each(function(){var l=h(this).data("attribute");h(this).find('option[value="'+j[l]+'"]').prop("selected",true)});k.find(".view").show();k.find(".edit").hide();k.find(".wc-shipping-class-edit").on("click",{view:this},this.onEditRow);k.find(".wc-shipping-class-delete").on("click",{view:this},this.onDeleteRow);k.find(".editing .wc-shipping-class-edit").trigger("click");k.find(".wc-shipping-class-cancel-edit").on("click",{view:this},this.onCancelEditRow);if(true===j.editing){k.addClass("editing");k.find(".wc-shipping-class-edit").trigger("click")}},onSubmit:function(i){i.data.view.block();i.data.view.model.save();i.preventDefault()},onAddNewRow:function(j){j.preventDefault();var i=j.data.view,u=i.model,l=_.indexBy(u.get("classes"),"term_id"),k={},t=_.size(l),v=_.extend({},e.default_shipping_class,{term_id:"new-"+t+"-"+Date.now(),editing:true,newRow:true});k[v.term_id]=v;u.logChanges(k);i.renderRow(v);h(".wc-shipping-classes-blank-state").remove()},onEditRow:function(i){i.preventDefault();h(this).closest("tr").addClass("editing");h(this).closest("tr").find(".view").hide();h(this).closest("tr").find(".edit").show();i.data.view.model.trigger("change:classes")},onDeleteRow:function(k){var i=k.data.view,t=i.model,s=_.indexBy(t.get("classes"),"term_id"),l={},j=h(this).closest("tr").data("id");k.preventDefault();if(s[j]){delete s[j];l[j]=_.extend(l[j]||{},{deleted:"deleted"});t.set("classes",s);t.logChanges(l)}i.render()},onCancelEditRow:function(l){var i=l.data.view,t=i.model,j=h(this).closest("tr"),k=h(this).closest("tr").data("id"),s=_.indexBy(t.get("classes"),"term_id");l.preventDefault();t.discardChanges(k);if(s[k]){s[k].editing=false;j.after(i.rowTemplate(s[k]));i.initRow(s[k])}j.remove()},setUnloadConfirmation:function(){this.needsUnloadConfirm=true;d.removeAttr("disabled")},clearUnloadConfirmation:function(){this.needsUnloadConfirm=false;d.attr("disabled","disabled")},unloadConfirmation:function(i){if(i.data.view.needsUnloadConfirm){i.returnValue=e.strings.unload_confirmation_msg;window.event.returnValue=e.strings.unload_confirmation_msg;return e.strings.unload_confirmation_msg}},updateModelOnChange:function(l){var x=l.data.view.model,i=h(l.target),j=i.closest("tr").data("id"),u=i.data("attribute"),k=i.val(),w=_.indexBy(x.get("classes"),"term_id"),v={};if(!w[j]||w[j][u]!==k){v[j]={};v[j][u]=k}x.logChanges(v)}}),o=new m({classes:e.classes}),b=new a({model:o,el:p});b.render()})})(jQuery,shippingClassesLocalizeScript,wp,ajaxurl);