(function(h,e,f,g){h(function(){var b=h(".wc-shipping-zone-methods"),o=h(".wc-shipping-zone-method-rows"),n=h(".wc-shipping-zone-method-save"),d=f.template("wc-shipping-zone-method-row"),r=f.template("wc-shipping-zone-method-row-blank"),p=Backbone.Model.extend({changes:{},logChanges:function(j){var i=this.changes||{};_.each(j.methods,function(l,k){i.methods=i.methods||{methods:{}};i.methods[k]=_.extend(i.methods[k]||{instance_id:k},l)});if(typeof j.zone_name!=="undefined"){i.zone_name=j.zone_name}if(typeof j.zone_locations!=="undefined"){i.zone_locations=j.zone_locations}if(typeof j.zone_postcodes!=="undefined"){i.zone_postcodes=j.zone_postcodes}this.changes=i;this.trigger("change:methods")},save:function(){h.post(g+(g.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zone_methods_save_changes",{wc_shipping_zones_nonce:e.wc_shipping_zones_nonce,changes:this.changes,zone_id:e.zone_id},this.onSaveResponse,"json")},onSaveResponse:function(j,i){if("success"===i){if(j.success){if(j.data.zone_id!==e.zone_id){e.zone_id=j.data.zone_id;if(window.history.pushState){window.history.pushState({},"","admin.php?page=wc-settings&tab=shipping&zone_id="+j.data.zone_id)}}q.set("methods",j.data.methods);q.trigger("change:methods");q.changes={};q.trigger("saved:methods")}else{window.alert(e.strings.save_failed)}}}}),c=Backbone.View.extend({rowTemplate:d,initialize:function(){this.listenTo(this.model,"change:methods",this.setUnloadConfirmation);this.listenTo(this.model,"saved:methods",this.clearUnloadConfirmation);this.listenTo(this.model,"saved:methods",this.render);o.on("change",{view:this},this.updateModelOnChange);o.on("sortupdate",{view:this},this.updateModelOnSort);h(window).on("beforeunload",{view:this},this.unloadConfirmation);n.on("click",{view:this},this.onSubmit);h(document.body).on("input change","#zone_name, #zone_locations, #zone_postcodes",{view:this},this.onUpdateZone);h(document.body).on("click",".wc-shipping-zone-method-settings",{view:this},this.onConfigureShippingMethod);h(document.body).on("click",".wc-shipping-zone-add-method",{view:this},this.onAddShippingMethod);h(document.body).on("wc_backbone_modal_response",this.onConfigureShippingMethodSubmitted);h(document.body).on("wc_backbone_modal_response",this.onAddShippingMethodSubmitted);h(document.body).on("change",".wc-shipping-zone-method-selector select",this.onChangeShippingMethodSelector);h(document.body).on("click",".wc-shipping-zone-postcodes-toggle",this.onTogglePostcodes)},onUpdateZone:function(j){var u=j.data.view,m=u.model,i=h(this).val(),v=h(j.target),k=v.data("attribute"),l={};j.preventDefault();l[k]=i;m.set(k,i);m.logChanges(l);u.render()},block:function(){h(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:0.6}})},unblock:function(){h(this.el).unblock()},render:function(){var i=_.indexBy(this.model.get("methods"),"instance_id"),k=this.model.get("zone_name"),j=this;h(".wc-shipping-zone-name").text(k?k:e.strings.default_zone_name);this.$el.empty();this.unblock();if(_.size(i)){i=_.sortBy(i,function(l){return parseInt(l.method_order,10)});h.each(i,function(l,m){if("yes"===m.enabled){m.enabled_icon='<span class="woocommerce-input-toggle woocommerce-input-toggle--enabled">'+e.strings.yes+"</span>"}else{m.enabled_icon='<span class="woocommerce-input-toggle woocommerce-input-toggle--disabled">'+e.strings.no+"</span>"}j.$el.append(j.rowTemplate(m));var t=j.$el.find('tr[data-id="'+m.instance_id+'"]');if(!m.has_settings){t.find(".wc-shipping-zone-method-title a").replaceWith(t.find(".wc-shipping-zone-method-title").text());t.find(".wc-shipping-zone-method-settings").remove()}});this.$el.find(".wc-shipping-zone-method-delete").on("click",{view:this},this.onDeleteRow);this.$el.find(".wc-shipping-zone-method-enabled a").on("click",{view:this},this.onToggleEnabled)}else{j.$el.append(r)}this.initTooltips()},initTooltips:function(){h("#tiptip_holder").removeAttr("style");h("#tiptip_arrow").removeAttr("style");h(".tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:50})},onSubmit:function(i){i.data.view.block();i.data.view.model.save();i.preventDefault()},onDeleteRow:function(j){var t=j.data.view,l=t.model,m=_.indexBy(l.get("methods"),"instance_id"),k={},i=h(this).closest("tr").data("id");j.preventDefault();delete m[i];k.methods=k.methods||{methods:{}};k.methods[i]=_.extend(k.methods[i]||{},{deleted:"deleted"});l.set("methods",m);l.logChanges(k);t.render()},onToggleEnabled:function(j){var w=j.data.view,x=h(j.target),l=w.model,v=_.indexBy(l.get("methods"),"instance_id"),i=x.closest("tr").data("id"),m=x.closest("tr").data("enabled")==="yes"?"no":"yes",k={};j.preventDefault();v[i].enabled=m;k.methods=k.methods||{methods:{}};k.methods[i]=_.extend(k.methods[i]||{},{enabled:m});l.set("methods",v);l.logChanges(k);w.render()},setUnloadConfirmation:function(){this.needsUnloadConfirm=true;n.removeAttr("disabled")},clearUnloadConfirmation:function(){this.needsUnloadConfirm=false;n.attr("disabled","disabled")},unloadConfirmation:function(i){if(i.data.view.needsUnloadConfirm){i.returnValue=e.strings.unload_confirmation_msg;window.event.returnValue=e.strings.unload_confirmation_msg;return e.strings.unload_confirmation_msg}},updateModelOnChange:function(k){var v=k.data.view.model,x=h(k.target),i=x.closest("tr").data("id"),l=x.data("attribute"),j=x.val(),w=_.indexBy(v.get("methods"),"instance_id"),m={};if(w[i][l]!==j){m.methods[i]={};m.methods[i][l]=j;w[i][l]=j}v.logChanges(m)},updateModelOnSort:function(i){var m=i.data.view,k=m.model,l=_.indexBy(k.get("methods"),"instance_id"),j={};_.each(l,function(v){var w=parseInt(v.method_order,10);var x=parseInt(b.find('tr[data-id="'+v.instance_id+'"]').index()+1,10);if(w!==x){l[v.instance_id].method_order=x;j.methods=j.methods||{methods:{}};j.methods[v.instance_id]=_.extend(j.methods[v.instance_id]||{},{method_order:x})}});if(_.size(j)){k.logChanges(j)}},onConfigureShippingMethod:function(k){var j=h(this).closest("tr").data("id"),l=k.data.view.model,m=_.indexBy(l.get("methods"),"instance_id"),i=m[j];if(!i.settings_html){return true}k.preventDefault();h(this).WCBackboneModal({template:"wc-modal-shipping-method-settings",variable:{instance_id:j,method:i},data:{instance_id:j,method:i}});h(document.body).trigger("init_tooltips")},onConfigureShippingMethodSubmitted:function(j,i,k){if("wc-modal-shipping-method-settings"===i){a.block();h.post(g+(g.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zone_methods_save_settings",{wc_shipping_zones_nonce:e.wc_shipping_zones_nonce,instance_id:k.instance_id,data:k},function(m,l){if("success"===l&&m.success){h("table.wc-shipping-zone-methods").parent().find("#woocommerce_errors").remove();if(m.data.errors.length>0){a.showErrors(m.data.errors)}if(_.size(a.model.changes)){a.model.save()}else{a.model.onSaveResponse(m,l)}}else{window.alert(e.strings.save_failed);a.unblock()}},"json")}},showErrors:function(i){var j='<div id="woocommerce_errors" class="error notice is-dismissible">';h(i).each(function(l,k){j=j+"<p>"+k+"</p>"});j=j+"</div>";h("table.wc-shipping-zone-methods").before(j)},onAddShippingMethod:function(i){i.preventDefault();h(this).WCBackboneModal({template:"wc-modal-add-shipping-method",variable:{zone_id:e.zone_id}});h(".wc-shipping-zone-method-selector select").change()},onAddShippingMethodSubmitted:function(j,i,k){if("wc-modal-add-shipping-method"===i){a.block();h.post(g+(g.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zone_add_method",{wc_shipping_zones_nonce:e.wc_shipping_zones_nonce,method_id:k.add_method_id,zone_id:e.zone_id},function(m,l){if("success"===l&&m.success){if(m.data.zone_id!==e.zone_id){e.zone_id=m.data.zone_id;if(window.history.pushState){window.history.pushState({},"","admin.php?page=wc-settings&tab=shipping&zone_id="+m.data.zone_id)}}if(_.size(a.model.changes)){a.model.save()}else{a.model.set("methods",m.data.methods);a.model.trigger("change:methods");a.model.changes={};a.model.trigger("saved:methods")}}a.unblock()},"json")}},onChangeShippingMethodSelector:function(){var i=h(this).find("option:selected").data("description");h(this).parent().find(".wc-shipping-zone-method-description").remove();h(this).after('<div class="wc-shipping-zone-method-description">'+i+"</div>");h(this).closest("article").height(h(this).parent().height())},onTogglePostcodes:function(i){i.preventDefault();var j=h(this).closest("tr");j.find(".wc-shipping-zone-postcodes").show();j.find(".wc-shipping-zone-postcodes-toggle").hide()}}),q=new p({methods:e.methods,zone_name:e.zone_name}),a=new c({model:q,el:o});a.render();o.sortable({items:"tr",cursor:"move",axis:"y",handle:"td.wc-shipping-zone-method-sort",scrollSensitivity:40})})})(jQuery,shippingZoneMethodsLocalizeScript,wp,ajaxurl);