(function(c,b,a,d){c(function(){var e=c(".wc-shipping-class-rows"),i=c(".wc-shipping-class-save"),j=a.template("wc-shipping-class-row"),g=a.template("wc-shipping-class-row-blank"),h=Backbone.Model.extend({changes:{},logChanges:function(m){var n=this.changes||{};_.each(m,function(o,p){n[p]=_.extend(n[p]||{term_id:p},o)});this.changes=n;this.trigger("change:classes")},save:function(){if(_.size(this.changes)){c.post(d+(d.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_classes_save_changes",{wc_shipping_classes_nonce:b.wc_shipping_classes_nonce,changes:this.changes},this.onSaveResponse,"json")}else{f.trigger("saved:classes")}},discardChanges:function(n){var m=this.changes||{};delete m[n];if(0===_.size(this.changes)){k.clearUnloadConfirmation()}},onSaveResponse:function(m,n){if("success"===n){if(m.success){f.set("classes",m.data.shipping_classes);f.trigger("change:classes");f.changes={};f.trigger("saved:classes")}else{if(m.data){window.alert(m.data)}else{window.alert(b.strings.save_failed)}}}k.unblock()}}),l=Backbone.View.extend({rowTemplate:j,initialize:function(){this.listenTo(this.model,"change:classes",this.setUnloadConfirmation);this.listenTo(this.model,"saved:classes",this.clearUnloadConfirmation);this.listenTo(this.model,"saved:classes",this.render);e.on("change",{view:this},this.updateModelOnChange);c(window).on("beforeunload",{view:this},this.unloadConfirmation);i.on("click",{view:this},this.onSubmit);c(document.body).on("click",".wc-shipping-class-add",{view:this},this.onAddNewRow);c(document.body).on("click",".wc-shipping-class-save-changes",{view:this},this.onSubmit)},block:function(){c(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:0.6}})},unblock:function(){c(this.el).unblock()},render:function(){var n=_.indexBy(this.model.get("classes"),"term_id"),m=this;this.$el.empty();this.unblock();if(_.size(n)){n=_.sortBy(n,function(o){return o.name});c.each(n,function(p,o){m.renderRow(o)})}else{m.$el.append(g)}},renderRow:function(n){var m=this;m.$el.append(m.rowTemplate(n));m.initRow(n)},initRow:function(o){var m=this;var n=m.$el.find('tr[data-id="'+o.term_id+'"]');n.find("select").each(function(){var p=c(this).data("attribute");c(this).find('option[value="'+o[p]+'"]').prop("selected",true)});n.find(".view").show();n.find(".edit").hide();n.find(".wc-shipping-class-edit").on("click",{view:this},this.onEditRow);n.find(".wc-shipping-class-delete").on("click",{view:this},this.onDeleteRow);n.find(".editing .wc-shipping-class-edit").trigger("click");n.find(".wc-shipping-class-cancel-edit").on("click",{view:this},this.onCancelEditRow);if(true===o.editing){n.addClass("editing");n.find(".wc-shipping-class-edit").trigger("click")}},onSubmit:function(m){m.data.view.block();m.data.view.model.save();m.preventDefault()},onAddNewRow:function(s){s.preventDefault();var m=s.data.view,o=m.model,q=_.indexBy(o.get("classes"),"term_id"),r={},p=_.size(q),n=_.extend({},b.default_shipping_class,{term_id:"new-"+p+"-"+Date.now(),editing:true,newRow:true});r[n.term_id]=n;o.logChanges(r);m.renderRow(n);c(".wc-shipping-classes-blank-state").remove()},onEditRow:function(m){m.preventDefault();c(this).closest("tr").addClass("editing");c(this).closest("tr").find(".view").hide();c(this).closest("tr").find(".edit").show();m.data.view.model.trigger("change:classes")},onDeleteRow:function(q){var m=q.data.view,n=m.model,o=_.indexBy(n.get("classes"),"term_id"),p={},r=c(this).closest("tr").data("id");q.preventDefault();if(o[r]){delete o[r];p[r]=_.extend(p[r]||{},{deleted:"deleted"});n.set("classes",o);n.logChanges(p)}m.render()},onCancelEditRow:function(p){var m=p.data.view,n=m.model,r=c(this).closest("tr"),q=c(this).closest("tr").data("id"),o=_.indexBy(n.get("classes"),"term_id");p.preventDefault();n.discardChanges(q);if(o[q]){o[q].editing=false;r.after(m.rowTemplate(o[q]));m.initRow(o[q])}r.remove()},setUnloadConfirmation:function(){this.needsUnloadConfirm=true;i.removeAttr("disabled")},clearUnloadConfirmation:function(){this.needsUnloadConfirm=false;i.attr("disabled","disabled")},unloadConfirmation:function(m){if(m.data.view.needsUnloadConfirm){m.returnValue=b.strings.unload_confirmation_msg;window.event.returnValue=b.strings.unload_confirmation_msg;return b.strings.unload_confirmation_msg}},updateModelOnChange:function(r){var n=r.data.view.model,m=c(r.target),t=m.closest("tr").data("id"),q=m.data("attribute"),s=m.val(),o=_.indexBy(n.get("classes"),"term_id"),p={};if(!o[t]||o[t][q]!==s){p[t]={};p[t][q]=s}n.logChanges(p)}}),f=new h({classes:b.classes}),k=new l({model:f,el:e});k.render()})})(jQuery,shippingClassesLocalizeScript,wp,ajaxurl);