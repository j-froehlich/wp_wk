(function(c,b,a,d){c(function(){if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}}var n=a.template("wc-tax-table-row"),q=a.template("wc-tax-table-row-empty"),h=a.template("wc-tax-table-pagination"),p=c(".wc_tax_rates"),k=c("#rates"),m=c('input[name="save"]'),l=c("#rates-pagination"),e=c("#rates-search .wc-tax-rates-search-field"),g=c(".submit .button-primary[type=submit]"),j=Backbone.Model.extend({changes:{},setRateAttribute:function(s,u,v){var r=_.indexBy(this.get("rates"),"tax_rate_id"),t={};if(r[s][u]!==v){t[s]={};t[s][u]=v;r[s][u]=v}this.logChanges(t)},logChanges:function(r){var s=this.changes||{};_.each(r,function(t,u){s[u]=_.extend(s[u]||{tax_rate_id:u},t)});this.changes=s;this.trigger("change:rates")},getFilteredRates:function(){var s=this.get("rates"),r=e.val().toLowerCase();if(r.length){s=_.filter(s,function(u){var t=_.toArray(u).join(" ").toLowerCase();return(-1!==t.indexOf(r))})}s=_.sortBy(s,function(t){return parseInt(t.tax_rate_order,10)});return s},block:function(){c(".wc_tax_rates").block({message:null,overlayCSS:{background:"#fff",opacity:0.6}})},unblock:function(){c(".wc_tax_rates").unblock()},save:function(){var r=this;r.block();Backbone.ajax({method:"POST",dataType:"json",url:d+(d.indexOf("?")>0?"&":"?")+"action=woocommerce_tax_rates_save_changes",data:{current_class:b.current_class,wc_tax_nonce:b.wc_tax_nonce,changes:r.changes},success:function(s,t){if("success"===t){i.set("rates",s.data.rates);i.trigger("change:rates");i.changes={};i.trigger("saved:rates");f.render()}r.unblock()}})}}),o=Backbone.View.extend({rowTemplate:n,per_page:b.limit,page:b.page,initialize:function(){var r=Math.ceil(_.toArray(this.model.get("rates")).length/this.per_page);this.qty_pages=0===r?1:r;this.page=this.sanitizePage(b.page);this.listenTo(this.model,"change:rates",this.setUnloadConfirmation);this.listenTo(this.model,"saved:rates",this.clearUnloadConfirmation);k.on("change autocompletechange",":input",{view:this},this.updateModelOnChange);e.on("keyup search",{view:this},this.onSearchField);l.on("click","a",{view:this},this.onPageChange);l.on("change","input",{view:this},this.onPageChange);c(window).on("beforeunload",{view:this},this.unloadConfirmation);g.on("click",{view:this},this.onSubmit);m.attr("disabled","disabled");p.find(".insert").on("click",{view:this},this.onAddNewRow);p.find(".remove_tax_rates").on("click",{view:this},this.onDeleteRow);p.find(".export").on("click",{view:this},this.onExport)},render:function(){var u=this.model.getFilteredRates(),r=_.size(u),v=Math.ceil(r/this.per_page),t=0===r?0:this.per_page*(this.page-1),w=this.per_page*this.page,x=_.toArray(u).slice(t,w),s=this;this.$el.empty();if(x.length){c.each(x,function(z,y){s.$el.append(s.rowTemplate(y))})}else{s.$el.append(q())}this.$el.find("td.country input").autocomplete({source:b.countries,minLength:2});this.$el.find("td.state input").autocomplete({source:b.states,minLength:3});this.$el.find("td.postcode input, td.city input").change(function(){c(this).attr("name",c(this).data("name"))});if(v>1){l.html(h({qty_rates:r,current_page:this.page,qty_pages:v}))}else{l.empty();s.page=1}},updateUrl:function(){if(!window.history.replaceState){return}var r=b.base_url,s=e.val();if(1<this.page){r+="&p="+encodeURIComponent(this.page)}if(s.length){r+="&s="+encodeURIComponent(s)}window.history.replaceState({},"",r)},onSubmit:function(r){r.data.view.model.save();r.preventDefault()},onAddNewRow:function(r){var y=r.data.view,v=y.model,A=_.indexBy(v.get("rates"),"tax_rate_id"),z={},C=_.size(A),B=_.extend({},b.default_rate,{tax_rate_id:"new-"+C+"-"+Date.now(),newRow:true}),s,w,x,u,t;s=k.children(".current");if(s.length){w=s.last().data("id");x=parseInt(A[w].tax_rate_order,10);B.tax_rate_order=1+x;u=_.filter(A,function(D){if(parseInt(D.tax_rate_order,10)>x){return true}return false});t=_.map(u,function(D){D.tax_rate_order++;z[D.tax_rate_id]=_.extend(z[D.tax_rate_id]||{},{tax_rate_order:D.tax_rate_order});return D})}else{B.tax_rate_order=1+_.max(_.pluck(A,"tax_rate_order"),function(D){return parseInt(D,10)});y.page=y.qty_pages}A[B.tax_rate_id]=B;z[B.tax_rate_id]=B;v.set("rates",A);v.logChanges(z);y.render()},onDeleteRow:function(x){var r=x.data.view,t=r.model,u=_.indexBy(t.get("rates"),"tax_rate_id"),w={},v,s;x.preventDefault();if(v=k.children(".current")){v.each(function(){s=c(this).data("id");delete u[s];w[s]=_.extend(w[s]||{},{deleted:"deleted"})});t.set("rates",u);t.logChanges(w);r.render()}else{window.alert(b.strings.no_rows_selected)}},onSearchField:function(r){r.data.view.updateUrl();r.data.view.render()},onPageChange:function(s){var r=c(s.currentTarget);s.preventDefault();s.data.view.page=r.data("goto")?r.data("goto"):r.val();s.data.view.render();s.data.view.updateUrl()},onExport:function(s){var r="data:application/csv;charset=utf-8,"+b.strings.csv_data_cols.join(",")+"\n";c.each(s.data.view.model.getFilteredRates(),function(v,t){var u="";u+=t.tax_rate_country+",";u+=t.tax_rate_state+",";u+=(t.postcode?t.postcode.join("; "):"")+",";u+=(t.city?t.city.join("; "):"")+",";u+=t.tax_rate+",";u+=t.tax_rate_name+",";u+=t.tax_rate_priority+",";u+=t.tax_rate_compound+",";u+=t.tax_rate_shipping+",";u+=b.current_class;r+=u+"\n"});c(this).attr("href",encodeURI(r));return true},setUnloadConfirmation:function(){this.needsUnloadConfirm=true;m.removeAttr("disabled")},clearUnloadConfirmation:function(){this.needsUnloadConfirm=false;m.attr("disabled","disabled")},unloadConfirmation:function(r){if(r.data.view.needsUnloadConfirm){r.returnValue=b.strings.unload_confirmation_msg;window.event.returnValue=b.strings.unload_confirmation_msg;return b.strings.unload_confirmation_msg}},updateModelOnChange:function(u){var s=u.data.view.model,r=c(u.target),w=r.closest("tr").data("id"),t=r.data("attribute"),v=r.val();if("city"===t||"postcode"===t){v=v.split(";");v=c.map(v,function(x){return x.trim()})}if("tax_rate_compound"===t||"tax_rate_shipping"===t){if(r.is(":checked")){v=1}else{v=0}}s.setRateAttribute(w,t,v)},sanitizePage:function(r){r=parseInt(r,10);if(r<1){r=1}else{if(r>this.qty_pages){r=this.qty_pages}}return r}}),i=new j({rates:b.rates}),f=new o({model:i,el:"#rates"});f.render()})})(jQuery,htmlSettingsTaxLocalizeScript,wp,ajaxurl);