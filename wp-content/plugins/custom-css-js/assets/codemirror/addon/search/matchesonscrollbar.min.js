"use strict";(function(a){"object"==typeof exports&&"object"==typeof module?a(require("../../lib/codemirror"),require("./searchcursor"),require("../scroll/annotatescrollbar")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../scroll/annotatescrollbar"],a):a(CodeMirror)})(function(c){function b(i,n,h,l){this.cm=i;this.options=l;var k={listenForChanges:!1},m;for(m in l){k[m]=l[m]}k.className||(k.className="CodeMirror-search-match");this.annotation=i.annotateScrollbar(k);this.query=n;this.caseFold=h;this.gap={from:i.firstLine(),to:i.lastLine()+1};this.matches=[];this.update=null;this.findMatches();this.annotation.update(this.matches);var j=this;i.on("change",this.changeHandler=function(e,d){j.onChange(d)})}function a(e,f,d){return e<=f?e:Math.max(f,e+d)}c.defineExtension("showMatchesOnScrollbar",function(e,f,d){"string"==typeof d&&(d={className:d});d||(d={});return new b(this,e,f,d)});b.prototype.findMatches=function(){if(this.gap){for(var f=0;f<this.matches.length;f++){var h=this.matches[f];if(h.from.line>=this.gap.to){break}h.to.line>=this.gap.from&&this.matches.splice(f--,1)}for(var d=this.cm.getSearchCursor(this.query,c.Pos(this.gap.from,0),this.caseFold),g=this.options&&this.options.maxMatches||1000;d.findNext();){h={from:d.from(),to:d.to()};if(h.from.line>=this.gap.to){break}this.matches.splice(f++,0,h);if(this.matches.length>g){break}}this.gap=null}};b.prototype.onChange=function(h){var l=h.from.line,d=c.changeEnd(h).line,k=d-h.to.line;this.gap?(this.gap.from=Math.min(a(this.gap.from,l,k),h.from.line),this.gap.to=Math.max(a(this.gap.to,l,k),h.from.line)):this.gap={from:h.from.line,to:d+1};if(k){for(h=0;h<this.matches.length;h++){var d=this.matches[h],j=a(d.from.line,l,k);j!=d.from.line&&(d.from=c.Pos(j,d.from.ch));j=a(d.to.line,l,k);j!=d.to.line&&(d.to=c.Pos(j,d.to.ch))}}clearTimeout(this.update);var i=this;this.update=setTimeout(function(){i.updateAfterChange()},250)};b.prototype.updateAfterChange=function(){this.findMatches();this.annotation.update(this.matches)};b.prototype.clear=function(){this.cm.off("change",this.changeHandler);this.annotation.clear()}});