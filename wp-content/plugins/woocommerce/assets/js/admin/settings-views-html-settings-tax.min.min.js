(function(h,e,f,g){h(function(){if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}}var d=f.template("wc-tax-table-row"),a=f.template("wc-tax-table-row-empty"),w=f.template("wc-tax-table-pagination"),b=h(".wc_tax_rates"),t=h("#rates"),r=h('input[name="save"]'),s=h("#rates-pagination"),z=h("#rates-search .wc-tax-rates-search-field"),x=h(".submit .button-primary[type=submit]"),u=Backbone.Model.extend({changes:{},setRateAttribute:function(l,j,i){var m=_.indexBy(this.get("rates"),"tax_rate_id"),k={};if(m[l][j]!==i){k[l]={};k[l][j]=i;m[l][j]=i}this.logChanges(k)},logChanges:function(j){var i=this.changes||{};_.each(j,function(l,k){i[k]=_.extend(i[k]||{tax_rate_id:k},l)});this.changes=i;this.trigger("change:rates")},getFilteredRates:function(){var i=this.get("rates"),j=z.val().toLowerCase();if(j.length){i=_.filter(i,function(k){var l=_.toArray(k).join(" ").toLowerCase();return(-1!==l.indexOf(j))})}i=_.sortBy(i,function(k){return parseInt(k.tax_rate_order,10)});return i},block:function(){h(".wc_tax_rates").block({message:null,overlayCSS:{background:"#fff",opacity:0.6}})},unblock:function(){h(".wc_tax_rates").unblock()},save:function(){var i=this;i.block();Backbone.ajax({method:"POST",dataType:"json",url:g+(g.indexOf("?")>0?"&":"?")+"action=woocommerce_tax_rates_save_changes",data:{current_class:e.current_class,wc_tax_nonce:e.wc_tax_nonce,changes:i.changes},success:function(k,j){if("success"===j){v.set("rates",k.data.rates);v.trigger("change:rates");v.changes={};v.trigger("saved:rates");y.render()}i.unblock()}})}}),c=Backbone.View.extend({rowTemplate:d,per_page:e.limit,page:e.page,initialize:function(){var i=Math.ceil(_.toArray(this.model.get("rates")).length/this.per_page);this.qty_pages=0===i?1:i;this.page=this.sanitizePage(e.page);this.listenTo(this.model,"change:rates",this.setUnloadConfirmation);this.listenTo(this.model,"saved:rates",this.clearUnloadConfirmation);t.on("change autocompletechange",":input",{view:this},this.updateModelOnChange);z.on("keyup search",{view:this},this.onSearchField);s.on("click","a",{view:this},this.onPageChange);s.on("change","input",{view:this},this.onPageChange);h(window).on("beforeunload",{view:this},this.unloadConfirmation);x.on("click",{view:this},this.onSubmit);r.attr("disabled","disabled");b.find(".insert").on("click",{view:this},this.onAddNewRow);b.find(".remove_tax_rates").on("click",{view:this},this.onDeleteRow);b.find(".export").on("click",{view:this},this.onExport)},render:function(){var l=this.model.getFilteredRates(),o=_.size(l),k=Math.ceil(o/this.per_page),m=0===o?0:this.per_page*(this.page-1),j=this.per_page*this.page,i=_.toArray(l).slice(m,j),n=this;this.$el.empty();if(i.length){h.each(i,function(p,q){n.$el.append(n.rowTemplate(q))})}else{n.$el.append(a())}this.$el.find("td.country input").autocomplete({source:e.countries,minLength:2});this.$el.find("td.state input").autocomplete({source:e.states,minLength:3});this.$el.find("td.postcode input, td.city input").change(function(){h(this).attr("name",h(this).data("name"))});if(k>1){s.html(w({qty_rates:o,current_page:this.page,qty_pages:k}))}else{s.empty();n.page=1}},updateUrl:function(){if(!window.history.replaceState){return}var j=e.base_url,i=z.val();if(1<this.page){j+="&p="+encodeURIComponent(this.page)}if(i.length){j+="&s="+encodeURIComponent(i)}window.history.replaceState({},"",j)},onSubmit:function(i){i.data.view.model.save();i.preventDefault()},onAddNewRow:function(i){var n=i.data.view,q=n.model,l=_.indexBy(q.get("rates"),"tax_rate_id"),m={},j=_.size(l),k=_.extend({},e.default_rate,{tax_rate_id:"new-"+j+"-"+Date.now(),newRow:true}),F,p,o,D,E;F=t.children(".current");if(F.length){p=F.last().data("id");o=parseInt(l[p].tax_rate_order,10);k.tax_rate_order=1+o;D=_.filter(l,function(A){if(parseInt(A.tax_rate_order,10)>o){return true}return false});E=_.map(D,function(A){A.tax_rate_order++;m[A.tax_rate_id]=_.extend(m[A.tax_rate_id]||{},{tax_rate_order:A.tax_rate_order});return A})}else{k.tax_rate_order=1+_.max(_.pluck(l,"tax_rate_order"),function(A){return parseInt(A,10)});n.page=n.qty_pages}l[k.tax_rate_id]=k;m[k.tax_rate_id]=k;q.set("rates",l);q.logChanges(m);n.render()},onDeleteRow:function(i){var o=i.data.view,m=o.model,l=_.indexBy(m.get("rates"),"tax_rate_id"),j={},k,n;i.preventDefault();if(k=t.children(".current")){k.each(function(){n=h(this).data("id");delete l[n];j[n]=_.extend(j[n]||{},{deleted:"deleted"})});m.set("rates",l);m.logChanges(j);o.render()}else{window.alert(e.strings.no_rows_selected)}},onSearchField:function(i){i.data.view.updateUrl();i.data.view.render()},onPageChange:function(i){var j=h(i.currentTarget);i.preventDefault();i.data.view.page=j.data("goto")?j.data("goto"):j.val();i.data.view.render();i.data.view.updateUrl()},onExport:function(i){var j="data:application/csv;charset=utf-8,"+e.strings.csv_data_cols.join(",")+"\n";h.each(i.data.view.model.getFilteredRates(),function(k,m){var l="";l+=m.tax_rate_country+",";l+=m.tax_rate_state+",";l+=(m.postcode?m.postcode.join("; "):"")+",";l+=(m.city?m.city.join("; "):"")+",";l+=m.tax_rate+",";l+=m.tax_rate_name+",";l+=m.tax_rate_priority+",";l+=m.tax_rate_compound+",";l+=m.tax_rate_shipping+",";l+=e.current_class;j+=l+"\n"});h(this).attr("href",encodeURI(j));return true},setUnloadConfirmation:function(){this.needsUnloadConfirm=true;r.removeAttr("disabled")},clearUnloadConfirmation:function(){this.needsUnloadConfirm=false;r.attr("disabled","disabled")},unloadConfirmation:function(i){if(i.data.view.needsUnloadConfirm){i.returnValue=e.strings.unload_confirmation_msg;window.event.returnValue=e.strings.unload_confirmation_msg;return e.strings.unload_confirmation_msg}},updateModelOnChange:function(k){var m=k.data.view.model,n=h(k.target),i=n.closest("tr").data("id"),l=n.data("attribute"),j=n.val();if("city"===l||"postcode"===l){j=j.split(";");j=h.map(j,function(o){return o.trim()})}if("tax_rate_compound"===l||"tax_rate_shipping"===l){if(n.is(":checked")){j=1}else{j=0}}m.setRateAttribute(i,l,j)},sanitizePage:function(i){i=parseInt(i,10);if(i<1){i=1}else{if(i>this.qty_pages){i=this.qty_pages}}return i}}),v=new u({rates:e.rates}),y=new c({model:v,el:"#rates"});y.render()})})(jQuery,htmlSettingsTaxLocalizeScript,wp,ajaxurl);