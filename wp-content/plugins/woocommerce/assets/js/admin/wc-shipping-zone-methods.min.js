(function(c,b,a,d){c(function(){var l=c(".wc-shipping-zone-methods"),h=c(".wc-shipping-zone-method-rows"),i=c(".wc-shipping-zone-method-save"),j=a.template("wc-shipping-zone-method-row"),e=a.template("wc-shipping-zone-method-row-blank"),g=Backbone.Model.extend({changes:{},logChanges:function(n){var o=this.changes||{};_.each(n.methods,function(p,q){o.methods=o.methods||{methods:{}};o.methods[q]=_.extend(o.methods[q]||{instance_id:q},p)});if(typeof n.zone_name!=="undefined"){o.zone_name=n.zone_name}if(typeof n.zone_locations!=="undefined"){o.zone_locations=n.zone_locations}if(typeof n.zone_postcodes!=="undefined"){o.zone_postcodes=n.zone_postcodes}this.changes=o;this.trigger("change:methods")},save:function(){c.post(d+(d.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zone_methods_save_changes",{wc_shipping_zones_nonce:b.wc_shipping_zones_nonce,changes:this.changes,zone_id:b.zone_id},this.onSaveResponse,"json")},onSaveResponse:function(n,o){if("success"===o){if(n.success){if(n.data.zone_id!==b.zone_id){b.zone_id=n.data.zone_id;if(window.history.pushState){window.history.pushState({},"","admin.php?page=wc-settings&tab=shipping&zone_id="+n.data.zone_id)}}f.set("methods",n.data.methods);f.trigger("change:methods");f.changes={};f.trigger("saved:methods")}else{window.alert(b.strings.save_failed)}}}}),k=Backbone.View.extend({rowTemplate:j,initialize:function(){this.listenTo(this.model,"change:methods",this.setUnloadConfirmation);this.listenTo(this.model,"saved:methods",this.clearUnloadConfirmation);this.listenTo(this.model,"saved:methods",this.render);h.on("change",{view:this},this.updateModelOnChange);h.on("sortupdate",{view:this},this.updateModelOnSort);c(window).on("beforeunload",{view:this},this.unloadConfirmation);i.on("click",{view:this},this.onSubmit);c(document.body).on("input change","#zone_name, #zone_locations, #zone_postcodes",{view:this},this.onUpdateZone);c(document.body).on("click",".wc-shipping-zone-method-settings",{view:this},this.onConfigureShippingMethod);c(document.body).on("click",".wc-shipping-zone-add-method",{view:this},this.onAddShippingMethod);c(document.body).on("wc_backbone_modal_response",this.onConfigureShippingMethodSubmitted);c(document.body).on("wc_backbone_modal_response",this.onAddShippingMethodSubmitted);c(document.body).on("change",".wc-shipping-zone-method-selector select",this.onChangeShippingMethodSelector);c(document.body).on("click",".wc-shipping-zone-postcodes-toggle",this.onTogglePostcodes)},onUpdateZone:function(s){var o=s.data.view,p=o.model,t=c(this).val(),n=c(s.target),r=n.data("attribute"),q={};s.preventDefault();q[r]=t;p.set(r,t);p.logChanges(q);o.render()},block:function(){c(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:0.6}})},unblock:function(){c(this.el).unblock()},render:function(){var p=_.indexBy(this.model.get("methods"),"instance_id"),n=this.model.get("zone_name"),o=this;c(".wc-shipping-zone-name").text(n?n:b.strings.default_zone_name);this.$el.empty();this.unblock();if(_.size(p)){p=_.sortBy(p,function(q){return parseInt(q.method_order,10)});c.each(p,function(s,r){if("yes"===r.enabled){r.enabled_icon='<span class="woocommerce-input-toggle woocommerce-input-toggle--enabled">'+b.strings.yes+"</span>"}else{r.enabled_icon='<span class="woocommerce-input-toggle woocommerce-input-toggle--disabled">'+b.strings.no+"</span>"}o.$el.append(o.rowTemplate(r));var q=o.$el.find('tr[data-id="'+r.instance_id+'"]');if(!r.has_settings){q.find(".wc-shipping-zone-method-title a").replaceWith(q.find(".wc-shipping-zone-method-title").text());q.find(".wc-shipping-zone-method-settings").remove()}});this.$el.find(".wc-shipping-zone-method-delete").on("click",{view:this},this.onDeleteRow);this.$el.find(".wc-shipping-zone-method-enabled a").on("click",{view:this},this.onToggleEnabled)}else{o.$el.append(e)}this.initTooltips()},initTooltips:function(){c("#tiptip_holder").removeAttr("style");c("#tiptip_arrow").removeAttr("style");c(".tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:50})},onSubmit:function(n){n.data.view.block();n.data.view.model.save();n.preventDefault()},onDeleteRow:function(r){var n=r.data.view,p=n.model,o=_.indexBy(p.get("methods"),"instance_id"),q={},s=c(this).closest("tr").data("id");r.preventDefault();delete o[s];q.methods=q.methods||{methods:{}};q.methods[s]=_.extend(q.methods[s]||{},{deleted:"deleted"});p.set("methods",o);p.logChanges(q);n.render()},onToggleEnabled:function(t){var o=t.data.view,n=c(t.target),r=o.model,p=_.indexBy(r.get("methods"),"instance_id"),u=n.closest("tr").data("id"),q=n.closest("tr").data("enabled")==="yes"?"no":"yes",s={};t.preventDefault();p[u].enabled=q;s.methods=s.methods||{methods:{}};s.methods[u]=_.extend(s.methods[u]||{},{enabled:q});r.set("methods",p);r.logChanges(s);o.render()},setUnloadConfirmation:function(){this.needsUnloadConfirm=true;i.removeAttr("disabled")},clearUnloadConfirmation:function(){this.needsUnloadConfirm=false;i.attr("disabled","disabled")},unloadConfirmation:function(n){if(n.data.view.needsUnloadConfirm){n.returnValue=b.strings.unload_confirmation_msg;window.event.returnValue=b.strings.unload_confirmation_msg;return b.strings.unload_confirmation_msg}},updateModelOnChange:function(s){var p=s.data.view.model,n=c(s.target),u=n.closest("tr").data("id"),r=n.data("attribute"),t=n.val(),o=_.indexBy(p.get("methods"),"instance_id"),q={};if(o[u][r]!==t){q.methods[u]={};q.methods[u][r]=t;o[u][r]=t}p.logChanges(q)},updateModelOnSort:function(r){var n=r.data.view,p=n.model,o=_.indexBy(p.get("methods"),"instance_id"),q={};_.each(o,function(u){var t=parseInt(u.method_order,10);var s=parseInt(l.find('tr[data-id="'+u.instance_id+'"]').index()+1,10);if(t!==s){o[u.instance_id].method_order=s;q.methods=q.methods||{methods:{}};q.methods[u.instance_id]=_.extend(q.methods[u.instance_id]||{},{method_order:s})}});if(_.size(q)){p.logChanges(q)}},onConfigureShippingMethod:function(p){var q=c(this).closest("tr").data("id"),o=p.data.view.model,n=_.indexBy(o.get("methods"),"instance_id"),r=n[q];if(!r.settings_html){return true}p.preventDefault();c(this).WCBackboneModal({template:"wc-modal-shipping-method-settings",variable:{instance_id:q,method:r},data:{instance_id:q,method:r}});c(document.body).trigger("init_tooltips")},onConfigureShippingMethodSubmitted:function(o,p,n){if("wc-modal-shipping-method-settings"===p){m.block();c.post(d+(d.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zone_methods_save_settings",{wc_shipping_zones_nonce:b.wc_shipping_zones_nonce,instance_id:n.instance_id,data:n},function(q,r){if("success"===r&&q.success){c("table.wc-shipping-zone-methods").parent().find("#woocommerce_errors").remove();if(q.data.errors.length>0){m.showErrors(q.data.errors)}if(_.size(m.model.changes)){m.model.save()}else{m.model.onSaveResponse(q,r)}}else{window.alert(b.strings.save_failed);m.unblock()}},"json")}},showErrors:function(o){var n='<div id="woocommerce_errors" class="error notice is-dismissible">';c(o).each(function(p,q){n=n+"<p>"+q+"</p>"});n=n+"</div>";c("table.wc-shipping-zone-methods").before(n)},onAddShippingMethod:function(n){n.preventDefault();c(this).WCBackboneModal({template:"wc-modal-add-shipping-method",variable:{zone_id:b.zone_id}});c(".wc-shipping-zone-method-selector select").change()},onAddShippingMethodSubmitted:function(o,p,n){if("wc-modal-add-shipping-method"===p){m.block();c.post(d+(d.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zone_add_method",{wc_shipping_zones_nonce:b.wc_shipping_zones_nonce,method_id:n.add_method_id,zone_id:b.zone_id},function(q,r){if("success"===r&&q.success){if(q.data.zone_id!==b.zone_id){b.zone_id=q.data.zone_id;if(window.history.pushState){window.history.pushState({},"","admin.php?page=wc-settings&tab=shipping&zone_id="+q.data.zone_id)}}if(_.size(m.model.changes)){m.model.save()}else{m.model.set("methods",q.data.methods);m.model.trigger("change:methods");m.model.changes={};m.model.trigger("saved:methods")}}m.unblock()},"json")}},onChangeShippingMethodSelector:function(){var n=c(this).find("option:selected").data("description");c(this).parent().find(".wc-shipping-zone-method-description").remove();c(this).after('<div class="wc-shipping-zone-method-description">'+n+"</div>");c(this).closest("article").height(c(this).parent().height())},onTogglePostcodes:function(o){o.preventDefault();var n=c(this).closest("tr");n.find(".wc-shipping-zone-postcodes").show();n.find(".wc-shipping-zone-postcodes-toggle").hide()}}),f=new g({methods:b.methods,zone_name:b.zone_name}),m=new k({model:f,el:h});m.render();h.sortable({items:"tr",cursor:"move",axis:"y",handle:"td.wc-shipping-zone-method-sort",scrollSensitivity:40})})})(jQuery,shippingZoneMethodsLocalizeScript,wp,ajaxurl);