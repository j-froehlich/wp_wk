jush.textarea=(function(){function i(n,m,o){var p={pos:0};h(n,m,o,p);return p.pos}function h(q,m,o,p){if(q.nodeType==3){if(q==m){p.pos+=o;return true}p.pos+=q.textContent.length}else{if(q==m){for(var n=0;n<o;n++){h(q.childNodes[n],m,o,p)}return true}else{if(/^(br|div)$/i.test(q.tagName)){p.pos++}for(var n=0;n<q.childNodes.length;n++){if(h(q.childNodes[n],m,o,p)){return true}}if(/^p$/i.test(q.tagName)){p.pos++}}}}function e(m,n){return c(m,{pos:n})}function c(p,o){if(p.nodeType==3){if(p.textContent.length>=o.pos){return{container:p,offset:o.pos}}o.pos-=p.textContent.length}else{for(var n=0;n<p.childNodes.length;n++){if(/^br$/i.test(p.childNodes[n].tagName)){if(!o.pos){return{container:p,offset:n}}o.pos--;if(!o.pos&&n==p.childNodes.length-1){return{container:p,offset:n}}}else{var m=c(p.childNodes[n],o);if(m){return m}}}}}function g(p,r,m){var q="txt";if(r.length<10000){var n=/(^|\s)(?:jush|language)-(\S+)/.exec(p.jushTextarea.className);q=(n?n[2]:"htm")}var o=jush.highlight(q,r).replace(/\n/g,"<br>");j(p,o,r,m)}function j(p,n,q,s){p.innerHTML=n;p.lastHTML=p.innerHTML;p.jushTextarea.value=q;if(s){var r=e(p,s);if(r){var m=document.createRange();m.setStart(r.container,r.offset);var o=getSelection();o.removeAllRanges();o.addRange(m)}}}function f(p){p=p||window.event;if((p.ctrlKey||p.metaKey)&&!p.altKey){var n=(p.keyCode==90);var o=(p.keyCode==89||(p.keyCode==90&&p.shiftKey));if(n||o){if(o){if(this.jushUndoPos+1<this.jushUndo.length){this.jushUndoPos++;var m=this.jushUndo[this.jushUndoPos];g(this,m.text,m.end)}}else{if(this.jushUndoPos>=0){this.jushUndoPos--;var m=this.jushUndo[this.jushUndoPos]||{html:"",text:""};g(this,m.text,this.jushUndo[this.jushUndoPos+1].start)}}return false}}else{k(this)}}function k(o){var n=getSelection();if(n.rangeCount){var m=n.getRangeAt(0);if(o.lastPos===undefined){o.lastPos=i(o,m.endContainer,m.endOffset)}}}function d(q,o){var s=q.lastPos;q.lastPos=undefined;var r=q.innerHTML;if(r!=q.lastHTML){var m;var p=getSelection();if(p.rangeCount){var n=p.getRangeAt(0);m=i(q,n.startContainer,n.startOffset)}r=r.replace(/<br>((<\/[^>]+>)*<\/?div>)(?!$)/gi,function(u,t){if(m){m--}return t});q.innerHTML=r.replace(/<(br|div)\b[^>]*>/gi,"\n").replace(/&nbsp;(<\/[pP]\b)/g,"$1").replace(/<\/p\b[^>]*>($|<p\b[^>]*>)/gi,"\n").replace(/(&nbsp;)+$/gm,"");g(q,q.textContent,m);q.jushUndo.length=q.jushUndoPos+1;if(o||!q.jushUndo.length||q.jushUndo[q.jushUndoPos].end!==s){q.jushUndo.push({text:q.jushTextarea.value,start:s,end:(o?undefined:m)});q.jushUndoPos++}else{q.jushUndo[q.jushUndoPos].text=q.jushTextarea.value;q.jushUndo[q.jushUndoPos].end=m}}}function a(){d(this)}function b(m){m=m||window.event;if(m.clipboardData){k(this);if(document.execCommand("insertHTML",false,jush.htmlspecialchars(m.clipboardData.getData("text")))){m.preventDefault()}d(this,true)}}return function l(m){if(!window.getSelection){return}var n=document.createElement("pre");n.contentEditable=true;n.className=m.className+" jush";n.style.border="1px inset #ccc";n.style.width=m.clientWidth+"px";n.style.height=m.clientHeight+"px";n.style.padding="3px";n.style.overflow="auto";n.style.resize="both";if(m.wrap!="off"){n.style.whiteSpace="pre-wrap"}n.jushTextarea=m;n.jushUndo=[];n.jushUndoPos=-1;n.onkeydown=f;n.onkeyup=a;n.onpaste=b;n.appendChild(document.createTextNode(m.value));d(n);if(m.spellcheck===false){document.documentElement.spellcheck=false}m.parentNode.insertBefore(n,m);if(document.activeElement===m&&!/firefox/i.test(navigator.userAgent)){n.focus()}m.style.display="none";return n}})();