var nfField=Backbone.Model.extend({toggleMetabox:function(){var b=this.id,c=this.get("metabox_state");if(1==c){var a=0}else{var a=1}1==a?this.updateHTML():(this.updateData(),jQuery("#ninja_forms_field_"+b+"_inside").find("div.rte").each(function(){if("undefined"!=typeof tinymce){try{var d=jQuery(this).find("textarea.wp-editor-area").prop("id");tinymce.remove("#"+d)}catch(f){}}}),jQuery("#ninja_forms_field_"+b+"_inside").slideUp("fast",function(){jQuery("#ninja_forms_field_"+b+"_inside").empty(),jQuery("#ninja_forms_field_"+b+"_inside").addClass("no-padding")})),this.set("metabox_state",a)},updateHTML:function(){var b=this.id;jQuery("#ninja_forms_metabox_field_"+b).find(".spinner").show(),jQuery("#ninja_forms_metabox_field_"+b).find(".spinner").css("visibility","visible"),this.updateData();var c=JSON.stringify(this.toJSON()),a=this;jQuery.post(ajaxurl,{field_id:b,data:c,action:"nf_output_field_settings_html",nf_ajax_nonce:ninja_forms_settings.nf_ajax_nonce},function(g){if(jQuery("#ninja_forms_metabox_field_"+b).find(".spinner").hide(),jQuery("#ninja_forms_field_"+b+"_inside").removeClass("no-padding"),jQuery("#ninja_forms_field_"+b+"_inside").append(g),"undefined"!=typeof nf_ajax_rte_editors&&"undefined"!=typeof tinyMCE){for(var e=nf_ajax_rte_editors.length-1;e>=0;e--){try{var d=nf_ajax_rte_editors[e];tinyMCE.init(tinyMCEPreInit.mceInit[d]);try{quicktags(tinyMCEPreInit.qtInit[d])}catch(f){console.log("error")}}catch(f){}}}a.removeEmptySettings(),jQuery("#ninja_forms_field_"+b+"_inside").slideDown("fast"),nfFields.listOptionsSortable(),jQuery(".nf-field-settings .title").disableSelection()})},updateData:function(){var g=this.id;if("undefined"!=typeof tinyMCE){try{tinyMCE.triggerSave()}catch(h){}}var d=jQuery("[name^=ninja_forms_field_"+g+"]"),c=jQuery(d).serializeFullArray();if("undefined"!=typeof c["ninja_forms_field_"+g]){var b=c["ninja_forms_field_"+g];for(var f in b){b.hasOwnProperty(f)&&nfFields.get(g).set(f,b[f])}}nfForm.set("saved",!1)},remove:function(){var a=this.id,b=confirm(nf_admin.remove_field);b&&jQuery.post(ajaxurl,{field_id:a,action:"ninja_forms_remove_field",nf_ajax_nonce:ninja_forms_settings.nf_ajax_nonce},function(){jQuery("#ninja_forms_field_"+a).remove(),jQuery(document).trigger("removeField",[a])})},removeEmptySettings:function(){var a=this.id;jQuery("#ninja_forms_field_"+a+"_inside").find(".nf-field-settings .inside").each(function(){var b=jQuery.trim(jQuery(this).html());""==b&&jQuery(this).parent().remove()})}}),nfFields=Backbone.Collection.extend({model:nfField,setup:function(){"undefined"!=typeof nf_admin.fields&&_.each(nf_admin.fields,function(a){nfFields.add({id:a.id,metabox_state:a.metabox_state})})},updateData:function(){_.each(this.models,function(a){1==a.get("metabox_state")&&a.updateData()})},newField:function(h){var j=jQuery(h).data("limit"),d=jQuery(h).data("type"),c=ninja_forms_settings.form_id;if(""!=j){var b=jQuery("."+d+"-li").length}else{var b=""}if("undefined"==typeof jQuery(h).data("field")){var f="",g="ninja_forms_new_field"}else{if("fav"==jQuery(h).data("type")){var f=jQuery(h).data("field"),g="ninja_forms_insert_fav"}else{var f=jQuery(h).data("field"),g="ninja_forms_insert_def"}}""!=j&&j>b||""==j||""==b||0==b?jQuery.post(ajaxurl,{type:d,field_id:f,form_id:c,action:g,nf_ajax_nonce:ninja_forms_settings.nf_ajax_nonce},this.newFieldResponse):jQuery(h).addClass("disabled"),nfForm.set("saved",!1)},newFieldResponse:function(a){jQuery(document).trigger("addField",[a])},addFieldDefault:function(c){if(jQuery("#ninja_forms_field_list").append(c.new_html).show("slow"),"List"==c.new_type&&this.listOptionsSortable(),"undefined"!=typeof nf_ajax_rte_editors&&"undefined"!=typeof tinyMCE){for(var d=nf_ajax_rte_editors.length-1;d>=0;d--){try{var b=nf_ajax_rte_editors[d];tinyMCE.init(tinyMCEPreInit.mceInit[b]);try{quicktags(tinyMCEPreInit.qtInit[b])}catch(a){}}catch(a){}}}this.add({id:c.new_id,metabox_state:1}),nfFields.get(c.new_id).removeEmptySettings()},listOptionsSortable:function(){jQuery(".ninja-forms-field-list-options").sortable({helper:"clone",handle:".ninja-forms-drag",items:"div",placeholder:"ui-state-highlight",update:function(){var a=jQuery(this).sortable("toArray"),b=0;_.each(a,function(j){var f=jQuery("#"+j).data("field"),d="ninja_forms_field_"+f+"[list][options]["+b+"][label]",c="ninja_forms_field_"+f+"[list][options]["+b+"][value]",g="ninja_forms_field_"+f+"[list][options]["+b+"][calc]",h="ninja_forms_field_"+f+"[list][options]["+b+"][selected]";jQuery("#"+j).find(".ninja-forms-field-list-option-label").attr("name",d),jQuery("#"+j).find(".ninja-forms-field-list-option-value").attr("name",c),jQuery("#"+j).find(".ninja-forms-field-list-option-calc").attr("name",g),jQuery("#"+j).find(".ninja-forms-field-list-option-selected").attr("name",h),b++})}})}}),nfForm=Backbone.Model.extend({defaults:{id:ninja_forms_settings.form_id,status:nf_admin.form_status,title:nf_admin.form_title,saved:!0},setup:function(){this.changeMenu()},changeMenu:function(){if("new"==this.get("status")){jQuery(".wp-submenu li").removeClass("current"),jQuery('a[href="admin.php?page=ninja-forms&tab=builder&form_id=new"]').parent().addClass("current")}else{var a='<li class="current"><a href="#">'+nf_admin.edit_form_text+"</a></li>";0==jQuery('li a:contains("'+nf_admin.edit_form_text+'")').length&&(jQuery(".wp-submenu li").removeClass("current"),jQuery('a[href="admin.php?page=ninja-forms&tab=builder&form_id=new"]').parent().after(a))}},save:function(){if(jQuery(".nf-save-admin-fields").hide(),jQuery(".nf-save-spinner").show(),jQuery(".nf-save-spinner").css("visibility","visible"),"new"==this.get("status")){return jQuery("._submit-li").length>0?(jQuery("#nf-insert-submit-div").hide(),this.set("show_insert_submit",!1)):(jQuery("#nf-insert-submit-div").show(),this.set("show_insert_submit",!0)),jQuery("#nf-save-title").nfAdminModal("open"),jQuery("#modal-contents-wrapper").find("#nf-form-title").focus(),!1}nfFields.updateData();for(var f=JSON.stringify(nfFields.toJSON()),g={},d=jQuery("#ninja_forms_field_list").sortable("toArray"),c=0;c<d.length;c++){g[c]=d[c]}g=JSON.stringify(g);var b=ninja_forms_settings.form_id;jQuery(document).data("field_order",g),jQuery(document).data("field_data",f),jQuery(document).triggerHandler("nfAdminSaveFields");var g=jQuery(document).data("field_order");jQuery(document).data("field_data");jQuery.post(ajaxurl,{form_title:this.get("title"),form_id:b,field_data:f,field_order:g,action:"nf_admin_save_builder",nf_ajax_nonce:ninja_forms_settings.nf_ajax_nonce},function(){jQuery(".nf-save-spinner").hide(),jQuery(".nf-save-admin-fields").show();var a='<div id="message" class="updated below-h2" style="display:none;margin-top: 20px;"><p>'+nf_admin.saved_text+"</p></div>";jQuery(".nav-tab-wrapper:last").after(a),jQuery("#message").fadeIn(),""==jQuery("#nf-display-form-title").html()&&jQuery("#nf-display-form-title").html(nfForm.get("title")),nfForm.set("saved",!0),nfForm.set("status",""),nfForm.changeMenu()})},saveTitle:function(){var c=jQuery("#modal-contents-wrapper").find("#nf-form-title").val(),d=this.get("show_insert_submit"),b=jQuery("#modal-contents-wrapper").find("#nf-insert-submit").prop("checked");if(this.set("title",c),this.set("status",""),d&&b){var a=this;jQuery(document).on("addField.insertSubmit",function(f,g){jQuery("#ninja_forms_field_"+g.new_id+"_toggle").click(),jQuery("#nf-save-title").nfAdminModal("close"),a.save(),jQuery(document).off("addField.insertSubmit")}),jQuery("#_submit").click()}else{jQuery("#nf-save-title").nfAdminModal("close"),this.save()}}}),nfFields=new nfFields,nfForm=new nfForm;!function(a){a(document).ready(function(b){nfFields.setup(),nfForm.setup(),b(document).on("click",".nf-edit-field",function(e){e.preventDefault();var d=jQuery(e.target).data("field");nfFields.get(d).toggleMetabox();var c=nfFields.get(d).get("metabox_state");1==c?b(this).addClass("open"):b(this).removeClass("open")}),b(document).on("click",function(){b("#message").fadeOut("slow")}),b(document).on("click",".nf-save-admin-fields",function(c){c.preventDefault(),nfForm.save()}),b(document).on("click","#nf-save-title-submit",function(c){c.preventDefault(),nfForm.saveTitle()}),b(document).on("click",".ninja-forms-new-field",function(c){c.preventDefault(),nfFields.newField(c.target)}),b(document).on("click",".nf-remove-field",function(c){c.preventDefault();var d=jQuery(c.target).data("field");nfFields.get(d).remove()}),b(document).on("addField.default",function(c,d){nfFields.addFieldDefault(d)}),b(document).on("click",".ninja-forms-insert-fav-field",function(c){c.preventDefault(),nfFields.newField(c.target)}),b(document).on("click",".ninja-forms-insert-def-field",function(c){c.preventDefault(),nfFields.newField(c.target)}),b("#nf-save-title").nfAdminModal({title:"Save Your Form",buttons:"#nf-save-title-buttons"}),b(document).on("nfAdminModalClose.hideSpinners",function(){jQuery(".nf-save-spinner").hide(),jQuery(".nf-save-admin-fields").show()}),b(document).on("keyup","#nf-form-title",function(c){this.value;this.value.length>0?(b("#modal-contents-wrapper").find("#nf-save-title-submit").prop("disabled",!1),b("#modal-contents-wrapper").find("#nf-save-title-submit").removeClass("button-secondary"),b("#modal-contents-wrapper").find("#nf-save-title-submit").addClass("button-primary")):(b("#modal-contents-wrapper").find("#nf-save-title-submit").prop("disabled",!0),b("#modal-contents-wrapper").find("#nf-save-title-submit").removeClass("button-primary"),b("#modal-contents-wrapper").find("#nf-save-title-submit").addClass("button-secondary")),13==c.keyCode&&this.value.length>0&&nfForm.saveTitle()}),b(".ninja-forms-field-list").sortable({handle:".menu-item-handle",items:"li:not(.not-sortable)",connectWith:".ninja-forms-field-list",start:function(e,d){var c=b(d.item).find(".wp-editor-wrap").length;c>0&&b(d.item).find(".wp-editor-wrap").each(function(){try{var f=this.id.replace("wp- ","");f=f.replace("-wrap",""),tinyMCE.execCommand("mceRemoveControl",!1,f)}catch(g){}})},stop:function(e,d){var c=b(d.item).find(".wp-editor-wrap").length;c>0&&b(d.item).find(".wp-editor-wrap").each(function(){try{var f=this.id.replace("wp-","");f=f.replace("-wrap",""),tinyMCE.execCommand("mceAddControl",!0,f)}catch(g){}}),b(this).sortable("refresh"),nfForm.set("saved",!1)}}),b(document).on("dblclick",".nf-field-settings .title",function(){b(this).find(".nf-field-sub-section-toggle").click()}),b(document).on("click",".nf-field-sub-section-toggle",function(c){c.preventDefault(),b(this).hasClass("dashicons-arrow-down")?b(this).removeClass("dashicons-arrow-down").addClass("dashicons-arrow-up"):b(this).removeClass("dashicons-arrow-up").addClass("dashicons-arrow-down"),b(this).parent().next(".inside").slideToggle()}),b(window).bind("beforeunload",function(){return"new"==nfForm.get("status")?(b("#nf-save-title").nfAdminModal("open"),"Please save your form before leaving this page."):0==nfForm.get("saved")?"You have unsaved changes. Please save before leaving this page.":void 0}),b(document).on("dblclick",".menu-item-handle",function(){b(this).find(".nf-edit-field").click()})})}(jQuery);